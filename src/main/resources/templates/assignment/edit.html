<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Редактирование назначения</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
  <div class="container">
    <a class="navbar-brand" href="/">Аварийная служба</a>
    <div class="navbar-nav">
      <a class="nav-link" th:href="@{/requests}">Заявки</a>
      <a class="nav-link" th:href="@{/brigades}">Бригады</a>
      <a class="nav-link active" th:href="@{/assignments}">Назначения</a>
    </div>
  </div>
</nav>

<div class="container">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a th:href="@{/assignments}">Назначения</a></li>
      <li class="breadcrumb-item">
        <a th:href="@{/assignments/{id}(id=${assignment.assignmentId})}">
          Назначение №<span th:text="${assignment.assignmentId}"></span>
        </a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">Редактирование</li>
    </ol>
  </nav>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Редактирование назначения №<span th:text="${assignment.assignmentId}"></span></h1>
    <span class="badge fs-6"
          th:classappend="'bg-' + ${assignment.endTime != null ? 'success' :
                                   assignment.startTime != null ? 'info' : 'secondary'}">
            <span th:if="${assignment.endTime != null}">Завершено</span>
            <span th:if="${assignment.endTime == null and assignment.startTime != null}">В работе</span>
            <span th:if="${assignment.endTime == null and assignment.startTime == null}">Назначено</span>
        </span>
  </div>

  <div th:if="${error != null}" class="alert alert-danger">
    <span th:text="${error}"></span>
  </div>

  <div class="row">
    <div class="col-md-4">
      <div class="card mb-4">
        <div class="card-header">
          <h6 class="mb-0">Текущая информация</h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Заявка:</label>
            <p class="form-control-plaintext">
              <a th:href="@{/requests/{id}(id=${assignment.request.requestId})}">
                №<span th:text="${assignment.request.requestId}"></span>
              </a>
            </p>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Бригада:</label>
            <p class="form-control-plaintext">
              <a th:href="@{/brigades/{id}(id=${assignment.brigade.brigadeId})}">
                <span th:text="${assignment.brigade.brigadeCode}"></span>
              </a>
            </p>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Текущий статус:</label>
            <p class="form-control-plaintext">
                            <span class="badge"
                                  th:classappend="'bg-' + ${assignment.brigade.status.name() == 'free' ? 'success' :
                                                       assignment.brigade.status.name() == 'inRoad' ? 'warning' :
                                                       assignment.brigade.status.name() == 'inPlace' ? 'info' : 'secondary'}">
                                <span th:text="${assignment.brigade.status.getToDisplay()}"></span>
                            </span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Редактирование временных меток</h5>
        </div>
        <div class="card-body">
          <form th:action="@{/assignments/{id}(id=${assignment.assignmentId})}"
                th:object="${assignmentForm}"
                method="post">

            <div class="mb-4">
              <label for="assignmentTime" class="form-label fw-bold">
                Время назначения
              </label>
              <input type="datetime-local"
                     class="form-control"
                     id="assignmentTime"
                     th:field="*{assignmentTime}"
                     th:value="${#temporals.format(assignmentForm.assignmentTime, 'yyyy-MM-dd''T''HH:mm')}"
                     required>
              <div class="text-danger" th:if="${#fields.hasErrors('assignmentTime')}">
                <span th:errors="*{assignmentTime}"></span>
              </div>
            </div>

            <div class="mb-4">
              <label for="startTime" class="form-label fw-bold">
                Время начала работ
              </label>
              <input type="datetime-local"
                     class="form-control"
                     id="startTime"
                     th:field="*{startTime}"
                     th:value="${assignmentForm.startTime != null ? #temporals.format(assignmentForm.startTime, 'yyyy-MM-dd''T''HH:mm') : ''}">
              <div class="text-danger" th:if="${#fields.hasErrors('startTime')}">
                <span th:errors="*{startTime}"></span>
              </div>
              <div class="form-text">
                Оставьте пустым, если работа еще не начата
              </div>
            </div>

            <div class="mb-4">
              <label for="endTime" class="form-label fw-bold">
                Время окончания работ
              </label>
              <input type="datetime-local"
                     class="form-control"
                     id="endTime"
                     th:field="*{endTime}"
                     th:value="${assignmentForm.endTime != null ? #temporals.format(assignmentForm.endTime, 'yyyy-MM-dd''T''HH:mm') : ''}">
              <div class="text-danger" th:if="${#fields.hasErrors('endTime')}">
                <span th:errors="*{endTime}"></span>
              </div>
              <div class="form-text">
                Оставьте пустым, если работа еще не завершена
              </div>
            </div>

            <div class="alert alert-warning">
              <h6 class="alert-heading">Правила временных меток:</h6>
              <ul class="mb-0">
                <li>Время назначения должно быть самым ранним</li>
                <li>Время начала работ должно быть позже времени назначения</li>
                <li>Время окончания работ должно быть позже времени начала работ</li>
                <li>Изменение временных меток автоматически обновит статусы бригады и заявки</li>
              </ul>
            </div>

            <div class="d-flex justify-content-between mt-4">
              <div>
                <button type="submit" class="btn btn-primary me-2">
                  Сохранить изменения
                </button>
                <a th:href="@{/assignments/{id}(id=${assignment.assignmentId})}" class="btn btn-secondary">
                  Отмена
                </a>
              </div>

              <form th:action="@{/assignments/{id}/delete(id=${assignment.assignmentId})}"
                    method="post"
                    class="d-inline"
                    onsubmit="return confirm('Удалить назначение? Это также изменит статусы заявки и бригады.')">
                <button type="submit" class="btn btn-outline-danger">Удалить назначение</button>
              </form>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>