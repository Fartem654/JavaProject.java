<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Новая заявка</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .required:after {
        content: " *";
        color: #dc3545;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    .info-box {
        background-color: #e7f3ff;
        border-left: 4px solid #0d6efd;
        padding: 15px;
        margin-bottom: 20px;
    }
    .priority-high { color: #dc3545; font-weight: bold; }
    .priority-medium { color: #ffc107; font-weight: bold; }
    .priority-low { color: #198754; font-weight: bold; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
  <div class="container">
    <a class="navbar-brand" href="/">Аварийная служба</a>
    <div class="navbar-nav">
      <a class="nav-link active" th:href="@{/requests}">Заявки</a>
      <a class="nav-link" th:href="@{/brigades}">Бригады</a>
      <a class="nav-link" th:href="@{/assignments}">Назначения</a>
    </div>
  </div>
</nav>

<div class="container">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a th:href="@{/requests}">Заявки</a></li>
      <li class="breadcrumb-item active" aria-current="page">Новая заявка</li>
    </ol>
  </nav>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Создание новой заявки</h1>
    <a th:href="@{/requests}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Назад к списку
    </a>
  </div>

  <div class="info-box">
    <h6 class="mb-2"><i class="bi bi-info-circle"></i> Информация о создании заявки</h6>
    <ul class="mb-0">
      <li>Все заявки создаются со статусом <span class="badge bg-secondary">Не принято</span></li>
      <li>После создания можно назначить бригаду на заявку</li>
      <li>Приоритет влияет на очередность обработки заявок</li>
      <li>Время подачи может быть любым</li>
    </ul>
  </div>

  <div th:if="${serverError != null}" class="alert alert-danger alert-dismissible fade show">
    <i class="bi bi-exclamation-triangle"></i>
    <strong>Ошибка сервера:</strong>
    <span th:text="${serverError}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div th:if="${error != null}" class="alert alert-danger alert-dismissible fade show">
    <i class="bi bi-exclamation-triangle"></i>
    <span th:text="${error}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div th:if="${success != null}" class="alert alert-success alert-dismissible fade show">
    <i class="bi bi-check-circle"></i>
    <span th:text="${success}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-8">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Данные заявки</h5>
        </div>
        <div class="card-body">
          <form th:action="@{/requests}"
                th:object="${requestNewForm}"
                method="post"
                id="requestForm">

            <!-- Тип аварии -->
            <div class="mb-4">
              <label for="accidentType" class="form-label fw-bold required">
                Тип аварии
              </label>
              <input type="text"
                     class="form-control"
                     id="accidentType"
                     th:field="*{accidentType}"
                     placeholder="Например: Прорыв водопровода, Обрыв электропровода, Утечка газа"
                     required
                     th:classappend="${#fields.hasErrors('accidentType')} ? 'is-invalid' : ''">
              <div class="invalid-feedback" th:if="${#fields.hasErrors('accidentType')}">
                <span th:errors="*{accidentType}"></span>
              </div>
              <div class="form-text">
                Опишите тип аварийной ситуации
              </div>
            </div>

            <div class="mb-4">
              <label for="priority" class="form-label fw-bold required">
                Приоритет
              </label>
              <select class="form-select"
                      id="priority"
                      th:field="*{priority}"
                      required
                      th:classappend="${#fields.hasErrors('priority')} ? 'is-invalid' : ''">
                <option value="">-- Выберите приоритет --</option>
                <option th:each="p : ${priorities}"
                        th:value="${p}"
                        th:text="${p.getToDisplayStr()}"
                        th:class="'priority-' + ${p.name().toLowerCase()}">
                </option>
              </select>
              <div class="invalid-feedback" th:if="${#fields.hasErrors('priority')}">
                <span th:errors="*{priority}"></span>
              </div>
              <div class="row mt-2">
                <div class="col-md-4">
                  <div class="alert alert-danger p-2">
                    <strong>Высокий (1)</strong><br>
                    <small>Угроза жизни, экстренная ситуация</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="alert alert-warning p-2">
                    <strong>Средний (2)</strong><br>
                    <small>Серьезная поломка, ограничение услуг</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="alert alert-success p-2">
                    <strong>Низкий (3)</strong><br>
                    <small>Незначительные неисправности</small>
                  </div>
                </div>
              </div>
            </div>

            <div class="mb-4">
              <label for="address" class="form-label fw-bold required">
                Адрес
              </label>
              <input type="text"
                     class="form-control"
                     id="address"
                     th:field="*{address}"
                     placeholder="Например: ул. Ленина, д. 10, кв. 5"
                     required
                     th:classappend="${#fields.hasErrors('address')} ? 'is-invalid' : ''">
              <div class="invalid-feedback" th:if="${#fields.hasErrors('address')}">
                <span th:errors="*{address}"></span>
              </div>
              <div class="form-text">
                Точный адрес места аварии
              </div>
            </div>

            <div class="mb-4">
              <label for="applicantName" class="form-label fw-bold required">
                Имя заявителя
              </label>
              <input type="text"
                     class="form-control"
                     id="applicantName"
                     th:field="*{applicantName}"
                     placeholder="Например: Иванов Иван Иванович"
                     required
                     th:classappend="${#fields.hasErrors('applicantName')} ? 'is-invalid' : ''">
              <div class="invalid-feedback" th:if="${#fields.hasErrors('applicantName')}">
                <span th:errors="*{applicantName}"></span>
              </div>
              <div class="form-text">
                ФИО лица, подающего заявку
              </div>
            </div>

            <div class="mb-4">
              <label for="submissionTime" class="form-label fw-bold required">
                Время подачи
              </label>
              <input type="datetime-local"
                     class="form-control"
                     id="submissionTime"
                     th:field="*{submissionTime}"
                     th:value="${#temporals.format(requestNewForm.submissionTime, 'yyyy-MM-dd''T''HH:mm')}"
                     required
                     th:classappend="${#fields.hasErrors('submissionTime')} ? 'is-invalid' : ''">
              <div class="invalid-feedback" th:if="${#fields.hasErrors('submissionTime')}">
                <span th:errors="*{submissionTime}"></span>
              </div>
              <div class="form-text">
                Дата и время подачи заявки.
              </div>
              <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setCurrentTime()">
                  <i class="bi bi-clock"></i> Установить текущее время
                </button>
              </div>
            </div>

            <div class="mb-4">
              <label for="description" class="form-label fw-bold">
                Описание ситуации
              </label>
              <textarea class="form-control"
                        id="description"
                        th:field="*{description}"
                        rows="4"
                        placeholder="Детальное описание аварийной ситуации, дополнительные сведения..."
                        th:classappend="${#fields.hasErrors('description')} ? 'is-invalid' : ''"></textarea>
              <div class="invalid-feedback" th:if="${#fields.hasErrors('description')}">
                <span th:errors="*{description}"></span>
              </div>
              <div class="form-text">
                Необязательное поле. Можно указать дополнительные детали
              </div>
            </div>

            <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger">
              <h6 class="alert-heading">Общие ошибки:</h6>
              <ul class="mb-0">
                <li th:each="err : ${#fields.globalErrors()}" th:text="${err}"></li>
              </ul>
            </div>

            <div class="d-flex justify-content-between mt-4 pt-3 border-top">
              <div>
                <button type="submit" class="btn btn-primary btn-sm">
                  <i class="bi bi-check-circle"></i> Создать заявку
                </button>
                <button type="reset" class="btn btn-outline-secondary btn-sm ms-2">
                  <i class="bi bi-x-circle"></i> Очистить форму
                </button>
              </div>
              <a th:href="@{/requests}" class="btn btn-secondary btn-sm align-self-center">
                Отмена
              </a>
            </div>
          </form>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header">
          <h6 class="mb-0"> Работа с заявками</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6>После создания:</h6>
              <ul>
                <li>Заявка получает статус <span class="badge bg-secondary">Не принято</span></li>
                <li>Заявка появится в общем списке</li>
                <li>Можно сразу назначить бригаду</li>
                <li>Приоритет определяет очередность обработки</li>
              </ul>
            </div>
            <div class="col-md-6">
              <h6>Статусы заявок:</h6>
              <ul>
                <li><span class="badge bg-secondary">Не принято</span> - нет назначенных бригад</li>
                <li><span class="badge bg-info">Принято</span> - бригада в пути</li>
                <li><span class="badge bg-warning">В работе</span> - бригада на месте</li>
                <li><span class="badge bg-success">Завершено</span> - работы выполнены</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Установка текущего времени
  function setCurrentTime() {
      const now = new Date();
      const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
          .toISOString()
          .slice(0, 16);
      document.getElementById('submissionTime').value = localDateTime;
  }

  // Автоматическая установка текущего времени при загрузке
  document.addEventListener('DOMContentLoaded', function() {
      const submissionTimeInput = document.getElementById('submissionTime');
      if (submissionTimeInput && !submissionTimeInput.value) {
          setCurrentTime();
      }

      // Подсветка приоритетов в выпадающем списке
      const prioritySelect = document.getElementById('priority');
      if (prioritySelect) {
          prioritySelect.addEventListener('change', function() {
              // Удаляем предыдущие классы
              this.classList.remove('priority-high', 'priority-medium', 'priority-low');

              // Добавляем соответствующий класс
              const value = this.value;
              if (value === 'High') {
                  this.classList.add('priority-high');
              } else if (value === 'Medium') {
                  this.classList.add('priority-medium');
              } else if (value === 'Low') {
                  this.classList.add('priority-low');
              }
          });

          // Инициализация при загрузке
          if (prioritySelect.value) {
              prioritySelect.dispatchEvent(new Event('change'));
          }
      }
  });

  // Автоматический подсчет символов в описании
  document.addEventListener('DOMContentLoaded', function() {
      const descriptionTextarea = document.getElementById('description');
      if (descriptionTextarea) {
          // Создаем счетчик символов
          const charCounter = document.createElement('div');
          charCounter.className = 'form-text text-end mt-1';
          charCounter.id = 'charCounter';
          charCounter.textContent = '0 / 1000 символов';
          descriptionTextarea.parentNode.appendChild(charCounter);

          // Обновляем счетчик
          descriptionTextarea.addEventListener('input', function() {
              const length = this.value.length;
              charCounter.textContent = `${length} / 1000 символов`;

              if (length > 1000) {
                  charCounter.classList.add('text-danger');
              } else {
                  charCounter.classList.remove('text-danger');
              }
          });

          // Инициализация
          descriptionTextarea.dispatchEvent(new Event('input'));
      }
  });
</script>
</body>
</html>