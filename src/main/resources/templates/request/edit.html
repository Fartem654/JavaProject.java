<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Редактирование заявки</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-4">
  <h1>Редактирование заявки <span th:text="*{requestId}"></span></h1>

  <!-- Информация о статусе -->
  <div class="alert alert-info mb-3">
    <strong>Текущий статус:</strong>
    <span th:text="${editForm.currentStatus?.getToDisplay()}"></span>

    <!-- Правила редактирования по статусу -->
    <div class="mt-2 small">
            <span th:if="${editForm.currentStatus?.name() == 'Not_Accepted'}">
                Можно редактировать все поля
            </span>
      <span th:if="${editForm.currentStatus?.name() == 'Accepted'}">
                Можно редактировать все, кроме приоритета
            </span>
      <span th:if="${editForm.currentStatus?.name() == 'In_Progress'}">
                Можно редактировать только тип аварии, имя заявителя, описание и время подачи
            </span>
    </div>
  </div>

  <form th:action="@{/requests/{id}(id=*{requestId})}"
        th:object="${editForm}"
        method="post"
        onsubmit="console.log('Form submitting...');">

    <input type="hidden" th:field="*{requestId}" />

    <div class="mb-3">
      <label for="accidentType" class="form-label">Тип аварии *</label>
      <input type="text"
             class="form-control"
             id="accidentType"
             th:field="*{accidentType}"
             th:readonly="${editForm.currentStatus?.name() == 'Completed'}"
             required>
      <div class="text-danger" th:if="${#fields.hasErrors('accidentType')}"
           th:errors="*{accidentType}"></div>
    </div>

    <div class="mb-3">
      <label for="priority" class="form-label">Приоритет *</label>
      <select class="form-select"
              id="priority"
              th:field="*{priority}"
              th:disabled="${editForm.currentStatus?.name() != 'Not_Accepted'}">
        <option value="">-- Выберите приоритет --</option>
        <option th:each="p : ${priorities}"
                th:value="${p}"
                th:text="${p.toDisplayStr}"
                th:selected="${editForm.priority == p}">
        </option>
      </select>
      <div class="text-danger" th:if="${#fields.hasErrors('priority')}"
           th:errors="*{priority}"></div>

      <div th:if="${editForm.currentStatus?.name() != 'Not_Accepted'}"
           class="form-text text-warning">
        Приоритет нельзя изменить для заявок в статусе "Принято" и выше
      </div>
    </div>

    <div class="mb-3">
      <label for="address" class="form-label">Адрес *</label>
      <input type="text"
             class="form-control"
             id="address"
             th:field="*{address}"
             th:readonly="${editForm.currentStatus?.name() == 'In_Progress' or
                                editForm.currentStatus?.name() == 'Completed'}"
             th:required="${editForm.currentStatus?.name() != 'In_Progress'}">
      <div class="text-danger" th:if="${#fields.hasErrors('address')}"
           th:errors="*{address}"></div>

      <div th:if="${editForm.currentStatus?.name() == 'In_Progress'}"
           class="form-text text-warning">
        Адрес нельзя изменить для заявок в статусе "В работе"
      </div>
    </div>

    <div class="mb-3">
      <label for="applicantName" class="form-label">Имя заявителя *</label>
      <input type="text"
             class="form-control"
             id="applicantName"
             th:field="*{applicantName}"
             th:readonly="${editForm.currentStatus?.name() == 'Completed'}"
             required>
      <div class="text-danger" th:if="${#fields.hasErrors('applicantName')}"
           th:errors="*{applicantName}"></div>
    </div>

    <div class="mb-3">
      <label for="submissionTime" class="form-label">Время подачи *</label>
      <input type="datetime-local"
             class="form-control"
             id="submissionTime"
             th:field="*{submissionTime}"
             th:readonly="${editForm.currentStatus?.name() == 'Completed'}">
      <div class="text-danger" th:if="${#fields.hasErrors('submissionTime')}"
           th:errors="*{submissionTime}"></div>
    </div>

    <div class="mb-3">
      <label for="description" class="form-label">Описание</label>
      <textarea class="form-control"
                id="description"
                th:field="*{description}"
                th:readonly="${editForm.currentStatus?.name() == 'Completed'}"
                rows="3"></textarea>
      <div class="text-danger" th:if="${#fields.hasErrors('description')}"
           th:errors="*{description}"></div>
    </div>

    <div class="mb-3">
      <div class="text-danger" th:if="${#fields.hasGlobalErrors()}">
        <ul>
          <li th:each="err : ${#fields.globalErrors()}" th:text="${err}"></li>
        </ul>
      </div>
    </div>

    <div class="mb-3">
      <button type="submit"
              class="btn btn-primary"
              th:disabled="${editForm.currentStatus?.name() == 'Completed'}">
        Сохранить изменения
      </button>
      <a th:href="@{/requests}" class="btn btn-secondary ms-2">Отмена</a>
    </div>
  </form>
</div>
</body>
</html>